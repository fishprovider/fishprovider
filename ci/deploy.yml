deploy-gate:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-gate/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
      - workers/gate/**/*
      when: always
  script:
    - curl $DEPLOY_GATE
  after_script:
    - NOTIF_MSG="Deploy gate $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]

deploy-cron:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-cron/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
      - workers/cron/**/*
      when: always
  script:
    - curl $DEPLOY_CRON
  after_script:
    - NOTIF_MSG="Deploy cron $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]

deploy-mon:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-mon/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
      - workers/mon/**/*
      when: always
  script:
    - curl $DEPLOY_MON
  after_script:
    - NOTIF_MSG="Deploy mon $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]

deploy-pay:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-pay/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
      - workers/pay/**/*
      when: always
  script:
    - curl $DEPLOY_PAY
    - curl $DEPLOY_PAY_DEMO
  after_script:
    - NOTIF_MSG="Deploy pay $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]

deploy-bot:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-bot/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
      - workers/bot/**/*
      when: always
  script:
    - curl $DEPLOY_BOT
    - curl $DEPLOY_BOT_DEMO
  after_script:
    - NOTIF_MSG="Deploy bot $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]

deploy-copy:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-copy/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
      - workers/copy/**/*
      when: always
  script:
    - curl $DEPLOY_COPY
    - curl $DEPLOY_COPY_DEMO
  after_script:
    - NOTIF_MSG="Deploy copy $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]

deploy-head-ctrader:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-head-ctrader/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
      - workers/head-ctrader/**/*
      when: always
  script:
    - curl $DEPLOY_HEAD_CTRADER
    - curl $DEPLOY_HEAD_CTRADER_DEMO
  after_script:
    - NOTIF_MSG="Deploy head-ctrader $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]

deploy-head-meta:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-head-meta/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
      - workers/head-meta/**/*
      when: always
  script:
    - curl $DEPLOY_HEAD_META
    - curl $DEPLOY_HEAD_META_DEMO
  after_script:
    - NOTIF_MSG="Deploy head-meta $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]

deploy-spot-ctrader:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-spot-ctrader/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
      - workers/spot-ctrader/**/*
      when: always
  script:
    - curl $DEPLOY_SPOT_CTRADER_ICMARKETS
    - curl $DEPLOY_SPOT_CTRADER_ICMARKETS_POLL
    - curl $DEPLOY_SPOT_CTRADER_ICMARKETS_DEMO
  after_script:
    - NOTIF_MSG="Deploy spot-ctrader $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]

deploy-spot-meta:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-spot-meta/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
      - workers/spot-meta/**/*
      when: always
  script:
    - curl $DEPLOY_SPOT_META_EXNESS
    - curl $DEPLOY_SPOT_META_EXNESS_POLL
    - curl $DEPLOY_SPOT_META_EXNESS_DEMO
  after_script:
    - NOTIF_MSG="Deploy spot-meta $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]

deploy-back:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-back/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
      - apps/back/**/*
      when: always
  script:
    - curl $DEPLOY_BACK
    - curl $DEPLOY_BACK_DEMO
    - curl $DEPLOY_BACK_CANARY
    - curl $DEPLOY_BACK_CANARY_DEMO
  after_script:
    - NOTIF_MSG="Deploy back $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]

deploy-phone:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-phone/
      when: always
    # - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    #   changes:
    #   - apps/phone/**/*
    #   when: always
  cache: !reference [.cache_npm, cache]
  script:
    - npm ci --cache .npm --prefer-offline --no-audit --no-progress --legacy-peer-deps
    - cd apps/phone
    - npx eas-cli@latest build --non-interactive --no-wait -p all --profile production --auto-submit
  after_script:
    - NOTIF_MSG="Deploy phone $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]

deploy-phone-schedule:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
  cache: !reference [.cache_npm, cache]
  script:
    - npm ci --cache .npm --prefer-offline --no-audit --no-progress --legacy-peer-deps
    - cd apps/phone
    - npx eas-cli@latest build --non-interactive --no-wait -p all --profile production --auto-submit
    - npx eas-cli@latest build --non-interactive --no-wait -p all --profile development
    - npx eas-cli@latest build --non-interactive --no-wait -p all --profile development-simulator
  after_script:
    - NOTIF_MSG="Deploy phone $CI_COMMIT_REF_NAME $CI_COMMIT_SHA"
    - !reference [.notif, script]
