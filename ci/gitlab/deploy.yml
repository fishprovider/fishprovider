include:
  - local: /ci/gitlab/_base.yml
  - local: /ci/gitlab/_deploy.yml

deploy-pay:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-pay/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - apps-backend/pay/**/*
      when: always
  script:
    - !reference [.deploy-pay, script]

deploy-bot:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-bot/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - apps-backend/bot/**/*
      when: always
  script:
    - !reference [.deploy-bot, script]

deploy-copy:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-copy/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - apps-backend/copy/**/*
      when: always
  script:
    - !reference [.deploy-copy, script]

deploy-head-ctrader:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-head-ctrader/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - apps-backend/head-ctrader/**/*
      when: always
  script:
    - !reference [.deploy-head-ctrader, script]

deploy-head-meta:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-head-meta/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - apps-backend/head-meta/**/*
      when: always
  script:
    - !reference [.deploy-head-meta, script]

deploy-spot-ctrader:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-spot-ctrader/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - apps-backend/spot-ctrader/**/*
      when: always
  script:
    - !reference [.deploy-spot-ctrader, script]

deploy-spot-meta:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-spot-meta/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - apps-backend/spot-meta/**/*
      when: always
  script:
    - !reference [.deploy-spot-meta, script]

deploy-back:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-back/
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - apps-backend/back/**/*
      when: always
  script:
    - !reference [.deploy-back, script]

deploy-phone:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TITLE =~ /deploy-phone/
      when: always
  cache: !reference [.cache_npm, cache]
  timeout: "100 minutes"
  script:
    - !reference [.deploy-phone, script]

deploy-phone-update:
  tags:
    - local
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_BRANCH =~ /prod-phone/
      when: always
  cache: !reference [.cache_npm, cache]
  script:
    - !reference [.deploy-phone-update, script]
